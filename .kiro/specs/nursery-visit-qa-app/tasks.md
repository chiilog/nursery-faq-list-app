# 実装計画

## MVP 範囲の定義

### Phase 1: 基本機能（MVP）

- ✅ 基本的な質問リスト作成・編集
- ✅ スマートフォン最適化 UI
- ✅ ローカルストレージでのデータ保存
- ✅ 基本的なデータセキュリティ

### Phase 2: 認証・共有・オフライン機能

- 🔄 OAuth 認証（Google/LINE）
- 🔄 リアルタイム共有（Supabase Realtime）
- 🔄 AWS Amplify Hosting へのデプロイ（プレビューデプロイ含む）
- 🔄 オフライン機能

### Phase 3: 高度な機能・Nice to Have

- 🔄 質問テンプレート
- 🔄 印刷機能
- 🔄 データエクスポート機能
- 🔄 高度なオフライン同期

## 実装タスク

### Phase 1: MVP 実装

- [x] 1. プロジェクト基盤構築とツール設定
  - 最新の Vite + React + TypeScript プロジェクト作成（`npm create vite@latest nursery-qa-app -- --template react-ts`）
  - TypeScript 設定の最適化（`isolatedModules: true`, `skipLibCheck: true`）
  - ESLint 設定（`@typescript-eslint/recommended-type-checked`, React 専用ルール）
  - Prettier 設定と VS Code 統合
  - Husky + lint-staged 設定
  - Vitest + React Testing Library + @testing-library/jest-dom の設定
  - _要件: 全体的な開発環境_

- [x] 1.1 Chakra UI とテーマ設定
  - 最新の Chakra UI v3 のインストールと基本設定
  - React 19 対応の TypeScript 型定義（`@types/react@^19.0.0 @types/react-dom@^19.0.0`）
  - カスタムテーマの作成（保育園アプリに適した色合い）
  - レスポンシブブレークポイントの設定
  - Vite 設定での Chakra UI 最適化
  - _要件: 1.1, 1.4_

### 2. データ層の実装（ローカルストレージ）

- [x] 2.1 データモデルと TypeScript 型定義
  - QuestionList, Question インターフェースの実装
  - バリデーション関数の作成とテスト
  - _要件: 7.1, 7.2_

- [x] 2.2 ローカルストレージ実装
  - localStorage API を使用したデータ保存
  - CRUD 操作の実装とテスト
  - 基本的なデータ保護
  - _要件: 6.1, 6.2_

- [x] 2.3 状態管理の実装
  - Zustand ストアの作成
  - 質問リスト状態管理の実装
  - 基本的なエラーハンドリング
  - _要件: 7.4_

### 3. 基本 UI コンポーネントの実装（TDD）

- [x] 3.1 レイアウトコンポーネント（TDD）
  - **Red**: レイアウトコンポーネントのテストを先に作成 ✅
  - **Green**: App, Layout, Router コンポーネントの最小実装 ✅
  - **Refactor**: ナビゲーション UI の改善、レスポンシブ対応 ✅
  - _要件: 1.1, 1.4_

- [x] 3.2 質問リスト表示コンポーネント（TDD）
  - **Red**: 質問表示・並び替えのテストを先に作成 ✅
  - **Green**: QuestionList コンポーネントの最小実装 ✅
  - **Refactor**: 回答済み質問の下部移動機能の改善 ✅
  - _要件: 1.3_

- [x] 3.3 質問入力・編集コンポーネント（TDD）
  - **Red**: 入力・編集機能のテストを先に作成 ✅
  - **Green**: QuestionItem, AnswerInput コンポーネントの最小実装 ✅
  - **Refactor**: スマートフォン最適化、リアルタイムバリデーション ✅
  - _要件: 1.1, 1.2, 7.1, 7.2_

### 4. シンプルUI設計への移行（2025年7月改訂）

- [x] 4.1 質問リスト作成機能（TDD）- 旧設計
  - **Red**: 質問リスト作成のテストを先に作成 ✅
  - **Green**: 新規質問リスト作成フォームの最小実装 ✅
  - **Refactor**: 基本情報入力、バリデーション、エラーハンドリングの改善 ✅
  - **Integration**: HomePageへの統合と実際の保存・表示機能の実装 ✅ (PR#20)
  - **NOTE**: シンプルUI設計に変更のため、この実装をベースに新設計へ移行
  - _要件: 1.5, 7.1, 7.4_

- [x] 4.2 保育園中心データモデルへの移行（TDD）
  - **Red**: 新しいデータモデル（Nursery, VisitSession）のテストを先に作成 ✅
  - **Green**: 保育園・見学セッション管理機能の最小実装 ✅
  - **Refactor**: 既存データの移行、UI/UXの改善 ✅
  - _要件: 1.5, 1.6, 1.7_

- [x] 4.3 保育園カード一覧UI（TDD）
  - **Red**: 保育園カード表示・操作のテストを先に作成 ✅
  - **Green**: ホーム画面の保育園カード一覧表示の最小実装 ✅
  - **Refactor**: 見学日・質問進捗表示の改善 ✅
  - _要件: 1.5, 1.6, 1.7_

- [x] 4.4 保育園追加機能（TDD）
  - **Red**: 保育園追加操作のテストを先に作成
  - **Green**: 「＋ 保育園を追加する」ボタンとフォームの最小実装
  - **Refactor**: 入力項目とバリデーションの改善
  - _要件: 1.5, 7.1, 7.4_

- [x] 4.5 保育園詳細画面（TDD）
  - **Red**: 保育園詳細表示・編集のテストを先に作成 ✅
  - **Green**: 統合された保育園詳細画面の最小実装 ✅
  - **Refactor**: 見学日設定、質問管理、回答入力機能の統合 ✅
  - _要件: 1.5, 1.7, 7.1, 7.2_

- [x] 4.6 見学日・質問進捗表示機能（TDD）
  - **Red**: 見学日・進捗表示のテストを先に作成 （NurseryCardで部分実装済み）
  - **Green**: カード内の見学日・質問進捗表示の最小実装 （NurseryCardで部分実装済み）
  - **Refactor**: 日付フォーマット、進捗計算の改善
  - _要件: 1.6, 1.7_

- [x] 4.7 @deprecated型の段階的削除（保育園中心設計への完全移行）
  - **Phase 1**: QuestionListCreator、QuestionList コンポーネントをNursery中心設計に変更
  - **Phase 2**: @deprecatedインターフェース（QuestionList、CreateQuestionListInput等）の削除
  - **Phase 3**: 関連するhooks、stores、servicesの削除
  - **Verification**: 全てのテストが新設計で動作することを確認
  - _要件: 保育園中心設計への完全移行_

- [x] 4.8 保育園削除機能（TDD）
  - **Red**: 保育園削除操作のテストを先に作成
    - 削除ボタンのクリックテスト
    - 確認ダイアログの表示テスト
    - カスケード削除のテスト
    - 削除後の画面遷移テスト
  - **Green**: 削除機能の最小実装
    - NurseryDetailPageに削除ボタン追加
    - 削除確認ダイアログコンポーネント
    - データストアとZustandストアの削除処理
    - ホーム画面への遷移処理
  - **Refactor**: 安全性とUXの改善
    - 保育園名入力による確認強化
    - 削除影響範囲の明示
    - エラーハンドリング強化
    - トースト通知の実装
  - _要件: 1.5, 7.4_

- [x] 4.9 気づきメモ機能のタグ化（TDD）
  - **Red**: タグ形式の気づき管理のテストを先に作成
    - タグ入力フィールドの表示テスト
    - Enterキーでのタグ追加テスト
    - 空文字のタグ追加防止テスト
    - タグの横並び表示テスト
    - タグ削除ボタンの動作テスト
    - LocalStorageへの保存テスト
  - **Green**: InsightsSectionコンポーネントの最小実装
    - 1行入力フィールドの実装
    - タグ追加機能の最小実装
    - タグ表示機能の最小実装
    - タグ削除機能の最小実装
  - **Refactor**: UI/UX改善とレスポンシブ対応
    - スマートフォン最適化
    - タグのスタイリング改善
    - エラーハンドリング強化
    - NotesSection関連コードの段階的削除
  - _要件: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 8.7_

### 5. データセキュリティ機能

- [x] 5.1 データ暗号化の実装
  - Web Crypto API を使用した暗号化
  - 暗号化キーの管理
  - データの暗号化・復号化処理
  - _要件: 6.1_

- [x] 5.2 データ削除機能
  - 完全削除機能の実装 ✅
  - カスケード削除の実装 ✅
  - 削除確認ダイアログの実装 ✅
  - _要件: 6.3_
  - _注: プライバシー配慮のログ実装はPhase 2（認証実装時）に移動_

### 6. テスト実装

- [x] 6.1 単体テストの実装
  - データモデルのテスト
  - ユーティリティ関数のテスト
  - コンポーネントのテスト（React Testing Library 使用）
  - _TDD: Red-Green-Refactor サイクル_

- [ ] 6.2 統合テストの実装
  - ページ間遷移のテスト
  - データフローのテスト
  - オフライン機能のテスト
  - _TDD: 統合的な動作確認_

- [ ] 6.3 E2E テストの実装
  - 主要ユーザーフローのテスト（Playwright 使用）
  - クロスブラウザテスト
  - PWA 機能のテスト
  - _TDD: ユーザーシナリオ全体_

### 7. パフォーマンス最適化

- [ ] 7.1 読み込み最適化
  - コード分割の実装
  - 画像・フォント最適化
  - Service Worker キャッシュ戦略
  - _パフォーマンス要件_

- [ ] 7.2 実行時最適化
  - React.memo, useMemo の適用
  - 仮想化の実装（大量データ対応）
  - デバウンス処理の実装
  - _パフォーマンス要件_

### 8. 分析・プライバシー機能の実装

- [x] 8.1 プライバシー管理基盤の実装（TDD）
  - **Red**: プライバシー設定管理のテストを先に作成
    - PrivacyManager クラスの同意状態管理テスト
    - LocalStorage への設定保存・読み込みテスト
    - 同意期限切れ判定のテスト
  - **Green**: プライバシー管理機能の最小実装
    - PrivacyManager クラスの実装
    - 同意状態の永続化機能
    - 設定変更時のイベント通知機能
  - **Refactor**: エラーハンドリングとパフォーマンス改善
    - 設定データの検証機能
    - 同意履歴の管理機能
  - _要件: 10.1, 10.2, 10.3, 10.4, 10.5, 10.6_

- [x] 8.2 クッキー同意バナーの実装（TDD）
  - **Red**: 同意バナー表示・操作のテストを先に作成
    - 初回訪問時のバナー表示テスト
    - 「同意する」「拒否する」ボタンの動作テスト
    - 同意後のバナー非表示テスト
    - プライバシーポリシーリンクのテスト
  - **Green**: CookieConsentBanner コンポーネントの最小実装
    - バナーの表示・非表示制御
    - 同意・拒否ボタンの実装
    - 設定保存機能の統合
  - **Refactor**: UI/UX とアクセシビリティの改善
    - スマートフォン最適化
    - キーボードナビゲーション対応
    - 多言語対応の準備
  - _要件: 10.1, 10.2, 10.3_

- [x] 8.3 プライバシー設定ページの実装（TDD）
  - **Red**: プライバシー設定画面のテストを先に作成
    - 現在の設定状況表示テスト
    - 個別設定（GA4/Clarity）の切り替えテスト
    - 設定変更時の即座反映テスト
    - プライバシーポリシーへのリンクテスト
  - **Green**: PrivacySettingsPage コンポーネントの最小実装
    - 設定状況の表示機能
    - スイッチによる設定変更機能
    - 分析サービスの有効化・無効化連携
  - **Refactor**: ユーザビリティとデザインの改善
    - 設定項目の説明文追加
    - 変更確認ダイアログの実装
    - 設定変更時のフィードバック強化
  - _要件: 10.4, 10.5_

- [x] 8.4 プライバシーポリシーページの実装（TDD）
  - **Red**: プライバシーポリシー表示のテストを先に作成
    - ポリシー内容の表示テスト
    - セクション別の内容確認テスト
    - プライバシー設定ページへのリンクテスト
    - レスポンシブ表示のテスト
  - **Green**: PrivacyPolicyPage コンポーネントの最小実装
    - ポリシー内容の構造化表示
    - ナビゲーションリンクの実装
    - 基本的なレイアウト機能
  - **Refactor**: 読みやすさとアクセシビリティの改善
    - 目次機能の追加
    - セクション内リンクの実装
    - 印刷対応の CSS 追加
  - _要件: 10.1, 10.4_

- [x] 8.5 Google Analytics 4 統合の実装（TDD）
  - **Red**: GA4 イベント送信のテストを先に作成
    - GA4 スクリプト読み込みのテスト
    - ページビューイベント送信のテスト
    - カスタムイベント送信のテスト
    - 同意状態による送信制御のテスト
  - **Green**: GA4Service クラスの最小実装
    - GA4 スクリプトの動的読み込み
    - 基本的なイベント送信機能
    - プライバシー設定の適用
  - **Refactor**: エラーハンドリングとパフォーマンス最適化
    - スクリプト読み込み失敗時の処理
    - 遅延読み込みの実装
    - デバッグ機能の追加（開発環境のみ）
    - Consent Mode v2 の導入
      - 初期状態で consent を denied に設定（ads, analytics）
      - 同意取得後に consent を granted に更新
      - EEA 等の地域別挙動に備えた拡張余地を確保
  - _要件: 9.1, 9.2, 9.6, 9.7_

- [x] 8.6 Microsoft Clarity 統合の実装（TDD）
  - **Red**: Clarity 機能のテストを先に作成
    - Clarity スクリプト読み込みのテスト
    - データマスキング機能のテスト
    - 同意状態による録画制御のテスト
    - 個人情報保護機能のテスト
  - **Green**: ClarityService クラスの最小実装
    - Clarity スクリプトの動的読み込み
    - 基本的な録画機能
    - 機密データのマスキング機能
  - **Refactor**: セキュリティとプライバシー保護の強化
    - 入力フィールドの自動マスキング
    - Do Not Track 設定の尊重
    - セッション録画の制御機能
  - _要件: 9.3, 9.4, 9.5, 9.6, 9.7_

- [ ] 8.7 分析機能統合の実装（シンプル化）
  - **Red**: AnalyticsProviderコンポーネントのテストを先に作成
    - 既存GA4Serviceとプライバシー設定の連携テスト
    - ClarityServiceフック化の実装とテスト
    - 同意状態変更時のサービス初期化テスト
  - **Green**: AnalyticsProviderの最小実装
    - useClarityServiceフックの実装（GA4と整合性を保つ）
    - 既存のusePrivacySettings, useGA4Service, useClarityServiceを統合
    - App.tsxでのラップ処理
  - **Refactor**: 動作確認とデバッグ機能
    - 開発環境でのログ出力
    - 環境変数の確認とエラーハンドリング
  - _要件: 9.1, 9.2_

- [ ] 8.8 環境設定とセキュリティ基礎対応（必要最小限）
  - 環境変数の確認とエラーハンドリング
  - 開発環境でのデバッグログ出力
  - 基本的なセキュリティヘッダー設定（将来対応）
  - _要件: 9.6, 9.7_

- [ ] 8.9 CSPセキュリティ強化（Phase 2以降で実装予定）
  - **MVPでは実装しない**（将来の改善タスク）
  - GA4/Clarityが動作することを優先
  - _要件: 9.6, 9.7（将来対応）_

### 9. デプロイメント準備

- [x] 9.1 ビルド設定の最適化
  - Vite ビルド設定の調整
  - PWA アセットの生成
  - 環境変数の設定（分析機能用の設定を含む）
  - _要件: 全般_

- [x] 9.2 AWS Amplify デプロイ設定
  - AWS Amplify プロジェクト作成とGitHub連携
  - ビルド設定の構成（amplify.yml）
  - 環境変数の設定（AWS Amplify Console）
    - VITE_GA4_MEASUREMENT_ID の設定
    - VITE_CLARITY_PROJECT_ID の設定
    - VITE_ANALYTICS_ENABLED の設定
    - VITE_ANALYTICS_DEBUG の設定（プレビュー/開発ブランチのみ true）
  - カスタムドメイン設定（オプション）
  - プレビューデプロイとブランチ戦略の設定
  - _要件: 全般_

### Phase 2: 認証・共有・オフライン機能

- [ ] 10. Supabase + AWS Amplify 統合設定
  - Supabase プロジェクト作成（認証・リアルタイム・データベース用）
  - Supabase データベーススキーマの実装（PostgreSQL）
  - AWS Amplify環境変数でのSupabase設定
  - Amplify Hosting での Supabase 接続設定
  - _要件: 2.1, 2.2, 2.3, 5.1, 5.2, 5.3, 5.4, 5.5, 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 10.1 Supabase Auth 認証実装
  - Google OAuth 設定（Supabase Dashboard）
  - LINE Login 設定（Supabase Dashboard）
  - フロントエンドでの認証実装（supabase-js）
  - AWS Amplify での Supabase Auth 統合
  - JWT 認証とセッション管理
  - _要件: 2.1, 2.2, 2.3_

- [ ] 10.2 Supabase Realtime 同期機能
  - Supabase Realtime 設定（Broadcast 機能）
  - フロントエンドでのリアルタイム送受信実装
  - 質問リストのリアルタイム同期
  - 競合解決機能（楽観的更新）
  - 同期状態表示（接続状況・送信状況）
  - _要件: 2.1, 2.2, 2.3_

- [ ] 10.3 データ同期とオフライン対応
  - ローカルストレージと Supabase の同期機能
  - オフライン時のデータ保存
  - オンライン復帰時の同期処理
  - 競合解決ロジック
  - _要件: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 10.4 プライバシー配慮のログ実装
  - エラーログの記録機能
  - 個人情報を含まないログ形式の実装
  - 削除操作のログ記録（日時とIDのみ）
  - Supabase/Sentryとの連携
  - _要件: 6.5_

### Phase 3: 高度な機能・Nice to Have

- [ ] 11. 質問テンプレート機能
  - 年齢別テンプレートの作成
  - テンプレート選択 UI
  - カスタマイズ機能
  - _要件: 3.1, 3.2, 3.3, 3.4_

- [ ] 11.1 印刷機能の実装
  - 印刷用レイアウトコンポーネントの作成
  - A4 用紙 4 分割レイアウトの実装
  - 印刷ボタンと CSS print media query の設定
  - _要件: 4.1, 4.2, 4.3_

- [ ] 11.2 データエクスポート機能
  - エクスポート形式の設計
  - エクスポート機能の実装
  - インポート機能の実装
  - _要件: 6.4_

## シンプルUI設計（2025年7月改訂）への対応

### 設計変更の背景

従来の設計では「ホーム」「保育園管理」「新規作成」など複数のナビゲーションがあり、ユーザーが各機能の役割を理解しにくい問題がありました。新しい設計では以下に簡素化します：

1. **ホーム画面 = 保育園一覧**
   - 保育園カードをメインコンテンツとして表示
   - 見学日と質問進捗を一目で把握可能

2. **ワンタップアクセス**
   - 保育園カードタップで詳細画面へ
   - 詳細画面で全ての操作が完結

3. **直感的なフロー**
   ```
   アプリ起動 → 保育園一覧 → カードタップ → 詳細画面
   ```

### 移行タスクの優先順位

**Phase 1a: シンプルUI設計移行（即座実装）**

1. 4.3 保育園カード一覧UI
2. 4.4 保育園追加機能
3. 4.6 見学日・質問進捗表示機能
4. 4.5 保育園詳細画面

**Phase 1b: データモデル改善（並行実装可能）**

1. 4.2 保育園中心データモデルへの移行

## 開発フロー

### TDD 実践方針

1. **Red**: 失敗するテストを先に書く
2. **Green**: テストを通す最小限のコードを実装
3. **Refactor**: コードを改善（テストは変更しない）

### Git コミット戦略

- **細かいコミット**: 各 TDD サイクル（Red-Green-Refactor）ごとにコミット
- **コミットメッセージ**: 以下の形式を推奨
  - `feat: 質問リスト作成機能のテスト追加 (Red)`
  - `feat: 質問リスト作成機能の最小実装 (Green)`
  - `refactor: 質問リスト作成機能のUI改善 (Refactor)`
- **ブランチ戦略**: 機能ごとに feature ブランチを作成
- **プルリクエスト**: 各タスク完了時に PR を作成し、セルフレビューを実施

### 実装順序

- 各タスクは前のタスクの完了を前提とする
- サブタスクは並行実装可能な場合がある
- MVP 完成後に Phase 2 の機能を検討

### 品質基準

- テストカバレッジ 80% 以上
- TypeScript strict モード対応
- アクセシビリティ WCAG AA 準拠
- パフォーマンス Lighthouse スコア 90+ 目標
