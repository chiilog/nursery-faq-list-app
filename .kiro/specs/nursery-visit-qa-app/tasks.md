# 実装計画

## MVP 範囲の定義

### Phase 1: 基本機能（MVP）

- ✅ 基本的な質問リスト作成・編集
- ✅ スマートフォン最適化 UI
- ✅ ローカルストレージでのデータ保存
- ✅ 基本的なデータセキュリティ

### Phase 2: 認証・共有・オフライン機能

- 🔄 OAuth 認証（Google/LINE）
- 🔄 リアルタイム共有（Supabase Realtime）
- 🔄 Cloudflare D1 との同期
- 🔄 オフライン機能

### Phase 3: 高度な機能・Nice to Have

- 🔄 質問テンプレート
- 🔄 印刷機能
- 🔄 データエクスポート機能
- 🔄 高度なオフライン同期

## 実装タスク

### Phase 1: MVP 実装

- [x] 1. プロジェクト基盤構築とツール設定
  - 最新の Vite + React + TypeScript プロジェクト作成（`npm create vite@latest nursery-qa-app -- --template react-ts`）
  - TypeScript 設定の最適化（`isolatedModules: true`, `skipLibCheck: true`）
  - ESLint 設定（`@typescript-eslint/recommended-type-checked`, React 専用ルール）
  - Prettier 設定と VS Code 統合
  - Husky + lint-staged 設定
  - Vitest + React Testing Library + @testing-library/jest-dom の設定
  - _要件: 全体的な開発環境_

- [x] 1.1 Chakra UI とテーマ設定
  - 最新の Chakra UI v3 のインストールと基本設定
  - React 19 対応の TypeScript 型定義（`@types/react@^19.0.0 @types/react-dom@^19.0.0`）
  - カスタムテーマの作成（保育園アプリに適した色合い）
  - レスポンシブブレークポイントの設定
  - Vite 設定での Chakra UI 最適化
  - _要件: 1.1, 1.4_

### 2. データ層の実装（ローカルストレージ）

- [x] 2.1 データモデルと TypeScript 型定義
  - QuestionList, Question インターフェースの実装
  - バリデーション関数の作成とテスト
  - _要件: 7.1, 7.2_

- [x] 2.2 ローカルストレージ実装
  - localStorage API を使用したデータ保存
  - CRUD 操作の実装とテスト
  - 基本的なデータ保護
  - _要件: 6.1, 6.2_

- [x] 2.3 状態管理の実装
  - Zustand ストアの作成
  - 質問リスト状態管理の実装
  - 基本的なエラーハンドリング
  - _要件: 7.4_

### 3. 基本 UI コンポーネントの実装（TDD）

- [x] 3.1 レイアウトコンポーネント（TDD）
  - **Red**: レイアウトコンポーネントのテストを先に作成 ✅
  - **Green**: App, Layout, Router コンポーネントの最小実装 ✅
  - **Refactor**: ナビゲーション UI の改善、レスポンシブ対応 ✅
  - _要件: 1.1, 1.4_

- [x] 3.2 質問リスト表示コンポーネント（TDD）
  - **Red**: 質問表示・並び替えのテストを先に作成 ✅
  - **Green**: QuestionList コンポーネントの最小実装 ✅
  - **Refactor**: 回答済み質問の下部移動機能の改善 ✅
  - _要件: 1.3_

- [x] 3.3 質問入力・編集コンポーネント（TDD）
  - **Red**: 入力・編集機能のテストを先に作成 ✅
  - **Green**: QuestionItem, AnswerInput コンポーネントの最小実装 ✅
  - **Refactor**: スマートフォン最適化、リアルタイムバリデーション ✅
  - _要件: 1.1, 1.2, 7.1, 7.2_

### 4. 保育園中心設計への移行（設計変更）

- [x] 4.1 質問リスト作成機能（TDD）- 旧設計
  - **Red**: 質問リスト作成のテストを先に作成 ✅
  - **Green**: 新規質問リスト作成フォームの最小実装 ✅
  - **Refactor**: 基本情報入力、バリデーション、エラーハンドリングの改善 ✅
  - **Integration**: HomePageへの統合と実際の保存・表示機能の実装 ✅ (PR#20)
  - **NOTE**: 保育園中心設計に変更のため、この実装をベースに新設計へ移行
  - _要件: 7.1, 7.4_

- [ ] 4.2 保育園中心データモデルへの移行（TDD）
  - **Red**: 新しいデータモデル（Nursery, VisitSession）のテストを先に作成
  - **Green**: 保育園・見学セッション管理機能の最小実装
  - **Refactor**: 既存データの移行、UI/UXの改善
  - _要件: 全般_

- [ ] 4.3 保育園管理機能の実装（TDD）
  - **Red**: 保育園CRUD操作のテストを先に作成
  - **Green**: 保育園一覧・作成・編集・削除の最小実装
  - **Refactor**: 保育園詳細情報、バリデーション強化
  - _要件: 7.1, 7.4_

- [ ] 4.4 見学セッション管理機能の実装（TDD）
  - **Red**: 見学セッションCRUD操作のテストを先に作成
  - **Green**: セッション一覧・作成・編集・削除の最小実装
  - **Refactor**: ステータス管理、日付処理の改善
  - _要件: 7.1, 7.4_

- [ ] 4.5 質問管理機能の再実装（TDD）
  - **Red**: 見学セッション内の質問CRUD操作のテストを作成
  - **Green**: 質問の動的追加・編集・削除の最小実装
  - **Refactor**: インライン編集、削除確認ダイアログの改善
  - _要件: 7.1, 7.2, 7.3_

- [ ] 4.6 質問の並び替え機能（TDD）
  - **Red**: 並び替え機能のテストを先に作成
  - **Green**: ドラッグ&ドロップの最小実装
  - **Refactor**: タッチデバイス対応、順序永続化の改善
  - _要件: 7.3_

### 5. データセキュリティ機能

- [ ] 5.1 データ暗号化の実装
  - Web Crypto API を使用した暗号化
  - 暗号化キーの管理
  - データの暗号化・復号化処理
  - _要件: 6.1_

- [ ] 5.2 データ削除機能
  - 完全削除機能の実装
  - プライバシー配慮のログ実装
  - _要件: 6.3, 6.5_

### 6. テスト実装

- [ ] 6.1 単体テストの実装
  - データモデルのテスト
  - ユーティリティ関数のテスト
  - コンポーネントのテスト（React Testing Library 使用）
  - _TDD: Red-Green-Refactor サイクル_

- [ ] 6.2 統合テストの実装
  - ページ間遷移のテスト
  - データフローのテスト
  - オフライン機能のテスト
  - _TDD: 統合的な動作確認_

- [ ] 6.3 E2E テストの実装
  - 主要ユーザーフローのテスト（Playwright 使用）
  - クロスブラウザテスト
  - PWA 機能のテスト
  - _TDD: ユーザーシナリオ全体_

### 7. パフォーマンス最適化

- [ ] 7.1 読み込み最適化
  - コード分割の実装
  - 画像・フォント最適化
  - Service Worker キャッシュ戦略
  - _パフォーマンス要件_

- [ ] 7.2 実行時最適化
  - React.memo, useMemo の適用
  - 仮想化の実装（大量データ対応）
  - デバウンス処理の実装
  - _パフォーマンス要件_

### 8. デプロイメント準備

- [ ] 8.1 ビルド設定の最適化
  - Vite ビルド設定の調整
  - PWA アセットの生成
  - 環境変数の設定
  - _デプロイメント準備_

- [ ] 8.2 Cloudflare Workers デプロイ設定
  - Cloudflare Workers プロジェクト作成（`npm create cloudflare@latest -- nursery-qa-app --framework=react`）
  - Workers Static Assets 設定
  - GitHub 連携と CI/CD 設定
  - カスタムドメイン設定（オプション）
  - プレビューデプロイの確認
  - _デプロイメント完了_

### Phase 2: 認証・共有・オフライン機能

- [ ] 9. Supabase + Cloudflare 統合設定
  - Supabase プロジェクト作成（認証・リアルタイム用）
  - D1 データベース作成（`wrangler d1 create nursery-qa-db`）
  - データベーススキーマの実装（SQLite）
  - Workers Binding 設定
  - _要件: 2.1, 2.2, 2.3, 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 9.1 Supabase Auth 認証実装
  - Google OAuth 設定（Supabase Dashboard）
  - LINE Login 設定（Supabase Dashboard）
  - フロントエンドでの認証実装（supabase-js）
  - Workers での Supabase Auth 検証
  - JWT 認証とセッション管理
  - _要件: 2.1, 2.2, 2.3_

- [ ] 9.2 Supabase Realtime 同期機能
  - Supabase Realtime 設定（Broadcast 機能）
  - フロントエンドでのリアルタイム送受信実装
  - 質問リストのリアルタイム同期
  - 競合解決機能（楽観的更新）
  - 同期状態表示（接続状況・送信状況）
  - _要件: 2.1, 2.2, 2.3_

- [ ] 9.3 データ同期とオフライン対応
  - ローカルストレージと D1 の同期機能
  - オフライン時のデータ保存
  - オンライン復帰時の同期処理
  - 競合解決ロジック
  - _要件: 2.1, 2.2, 2.3_

### Phase 3: 高度な機能・Nice to Have

- [ ] 10. 質問テンプレート機能
  - 年齢別テンプレートの作成
  - テンプレート選択 UI
  - カスタマイズ機能
  - _要件: 3.1, 3.2, 3.3, 3.4_

- [ ] 10.1 印刷機能の実装
  - 印刷用レイアウトコンポーネントの作成
  - A4 用紙 4 分割レイアウトの実装
  - 印刷ボタンと CSS print media query の設定
  - _要件: 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ] 10.2 データエクスポート機能
  - エクスポート形式の設計
  - エクスポート機能の実装
  - インポート機能の実装
  - _要件: 6.4_

## 開発フロー

### TDD 実践方針

1. **Red**: 失敗するテストを先に書く
2. **Green**: テストを通す最小限のコードを実装
3. **Refactor**: コードを改善（テストは変更しない）

### Git コミット戦略

- **細かいコミット**: 各 TDD サイクル（Red-Green-Refactor）ごとにコミット
- **コミットメッセージ**: 以下の形式を推奨
  - `feat: 質問リスト作成機能のテスト追加 (Red)`
  - `feat: 質問リスト作成機能の最小実装 (Green)`
  - `refactor: 質問リスト作成機能のUI改善 (Refactor)`
- **ブランチ戦略**: 機能ごとに feature ブランチを作成
- **プルリクエスト**: 各タスク完了時に PR を作成し、セルフレビューを実施

### 実装順序

- 各タスクは前のタスクの完了を前提とする
- サブタスクは並行実装可能な場合がある
- MVP 完成後に Phase 2 の機能を検討

### 品質基準

- テストカバレッジ 80% 以上
- TypeScript strict モード対応
- アクセシビリティ WCAG AA 準拠
- パフォーマンス Lighthouse スコア 90+ 目標
